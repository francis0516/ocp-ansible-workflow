---
- name: Add VM to dynamic inventory if running standalone
  hosts: localhost
  gather_facts: false
  vars:
    cloud_init_password: password
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  tasks:
    - name: Add VM to dynamic inventory
      add_host:
        name: apache-vm
        ansible_host: "{{ vm_ip }}"
        ansible_user: root
        ansible_password: "{{ cloud_init_password }}"
        ansible_ssh_common_args: "{{ ansible_ssh_common_args }}"
        groups: dynamic_vms
      when: vm_ip is defined

- hosts: dynamic_vms
  gather_facts: yes
  become: yes

  vars:
    vm_ip: "{{ hostvars['localhost']['vm_ip'] | default('10.0.0.130') }}"

  tasks:
    - name: Configure persistent static network for eth0
      block:
        - name: Delete existing eth0 connection (if any)
          command: nmcli con delete eth0
          ignore_errors: yes

        - name: Add new eth0 connection
          command: >
            nmcli connection add type ethernet autoconnect yes con-name eth0 ifname eth0
          ignore_errors: yes

        - name: Configure IP address using vm_ip
          command: nmcli connection modify eth0 ipv4.addresses {{ vm_ip }}/24 ipv4.method manual

        - name: Configure DNS servers
          command: nmcli connection modify eth0 ipv4.dns "10.0.0.17,8.8.8.8"

        - name: Configure gateway
          command: nmcli connection modify eth0 ipv4.gateway 10.0.0.1

        - name: Configure DNS search domain
          command: nmcli connection modify eth0 ipv4.dns-search ocp4.henogez.com

        - name: Bring up eth0
          command: nmcli connection up eth0

        - name: Restart NetworkManager
          systemd:
            name: NetworkManager
            state: restarted

    - name: Install Apache (httpd) package
      dnf:
        name: httpd
        state: present

    - name: Start and enable Apache service
      systemd:
        name: httpd
        state: started
        enabled: yes

    - name: Verify Apache is running
      systemd:
        name: httpd
      register: httpd_status

    - name: Display Apache service status
      debug:
        msg: "Apache service is {{ httpd_status.status.ActiveState }}"

    - name: Test Apache locally from VM
      uri:
        url: "http://localhost"
        return_content: yes
        status_code: [200, 403]
      register: local_test
      ignore_errors: yes

    - name: Display local test result
      debug:
        msg: "Local test successful - Apache is responding"
      when: local_test is succeeded and local_test.status in [200, 403]

    - name: Display local test warning
      debug:
        msg: "Warning: Local Apache test failed, but continuing deployment"
      when: local_test is failed

    - name: Display VM information
      debug:
        msg:
          - "==================================================="
          - "Henogez Webserver Deployment Complete Successfully!"
          - "==================================================="
          - "   Server Details:"
          - "   Hostname: {{ ansible_hostname }}"
          - "   IP: {{ ansible_default_ipv4.address }}"
          - "   Status: {{ httpd_status.status.ActiveState }}"
          - ""
          - "   Next Step: Create Service/Route for external access"
          - "=============================================="
