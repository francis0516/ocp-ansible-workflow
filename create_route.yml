---
- name: Create OpenShift Route for Apache VM
  hosts: localhost
  gather_facts: no
  vars:
    vm_name: apache-vm
    vm_namespace: vm-migration-test
    service_name: apache-vm-service
    route_name: apache-vm-route
    port_name: http
    target_port: 80

  tasks:
    - name: Set effective VM name and namespace
      set_fact:
        effective_vm_name: "{{ vm_name }}"
        effective_namespace: "{{ vm_namespace }}"

    - name: Get VM information
      kubernetes.core.k8s_info:
        api_version: kubevirt.io/v1
        kind: VirtualMachine
        name: "{{ effective_vm_name }}"
        namespace: "{{ effective_namespace }}"
      register: vm_info
      failed_when: false

    - name: Fail if VM does not exist
      fail:
        msg: "The VM '{{ effective_vm_name }}' was not found in namespace '{{ effective_namespace }}'."
      when: vm_info.resources | length == 0

    ###################################################################
    # FIX: Wait and retry until the VM has an IPv4 address assigned
    ###################################################################
    - name: Wait until VM has IPv4 assigned
      kubernetes.core.k8s_info:
        api_version: kubevirt.io/v1
        kind: VirtualMachineInstance
        name: "{{ effective_vm_name }}"
        namespace: "{{ effective_namespace }}"
      register: vmi_info
      until:
        - vmi_info.resources | length > 0
        - vmi_info.resources[0].status.interfaces is defined
        - (vmi_info.resources[0].status.interfaces | selectattr('ipAddresses', 'defined') | list) | length > 0
      retries: 20
      delay: 10

    - name: Fetch VM IPv4 from first interface with IPv4
      set_fact:
        vm_ip: "{{ (vmi_info.resources[0].status.interfaces | selectattr('ipAddresses', 'defined') | list)[0].ipAddresses[0] }}"

    - name: Display VM IPv4
      debug:
        msg: "‚úÖ VM IPv4: {{ vm_ip }}"

    ###################################################################
    # Create the Service for Apache VM
    ###################################################################
    - name: Create Service for Apache VM
      kubernetes.core.k8s:
        state: present
        namespace: "{{ effective_namespace }}"
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ service_name }}"
            labels:
              app: apache-vm
          spec:
            selector:
              kubevirt.io/domain: "{{ effective_vm_name }}"
            ports:
              - name: "{{ port_name }}"
                protocol: TCP
                port: 80
                targetPort: 80

    ###################################################################
    # Create the Route to expose Apache externally
    ###################################################################
    - name: Create Route for Apache VM
      kubernetes.core.k8s:
        state: present
        namespace: "{{ effective_namespace }}"
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: "{{ route_name }}"
          spec:
            to:
              kind: Service
              name: "{{ service_name }}"
            port:
              targetPort: "{{ port_name }}"
            tls:
              termination: edge
      register: route_result

    ###################################################################
    # Display final status summary
    ###################################################################
    - name: Display final Route and VM information
      debug:
        msg:
          - "==================================================================="
          - " üåê External URL (HTTPS): https://{{ route_result.result.spec.host }}"
          - " üåê Internal VM IP: http://{{ vm_ip }}"
          - " üåê Internal Service: http://{{ service_name }}.{{ effective_namespace }}.svc.cluster.local"
          - " ------------------------------------------------------------------"
          - " üß± Resource Details:"
          - "    VM Name: {{ effective_vm_name }}"
          - "    Namespace: {{ effective_namespace }}"
          - "    Service: {{ service_name }}"
          - "    Route: {{ route_name }}"
          - " ------------------------------------------------------------------"
          - " ‚úÖ Route Status: Admitted: {{ route_result.result.status.ingress[0].conditions[0].status | default('Unknown') }}"
          - "==================================================================="
