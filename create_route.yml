- hosts: localhost
  gather_facts: false

  vars:
    default_vm_name: "apache-vm"
    default_vm_namespace: "vm-migration-test"

  tasks:

    - name: Set effective VM name and namespace
      set_fact:
        vm_name: "{{ vm_name | default(default_vm_name) }}"
        vm_namespace: "{{ vm_namespace | default(default_vm_namespace) }}"

    - name: Get VM information
      kubernetes.core.k8s_info:
        api_version: kubevirt.io/v1
        kind: VirtualMachine
        name: "{{ vm_name }}"
        namespace: "{{ vm_namespace }}"
      register: vm_info
      ignore_errors: yes

    - name: Fail if VM does not exist
      fail:
        msg: "âŒ VM '{{ vm_name }}' not found in namespace '{{ vm_namespace }}'."
      when: (vm_info.resources | default([])) | length == 0

    - name: Get VMI information
      kubernetes.core.k8s_info:
        api_version: kubevirt.io/v1
        kind: VirtualMachineInstance
        name: "{{ vm_name }}"
        namespace: "{{ vm_namespace }}"
      register: vmi_info

    - name: Debug VMI info
      debug:
        var: vmi_info

    - name: Fetch VM IPv4 from first interface with IPv4
      set_fact:
        vm_ip: >-
          {{ (vmi_info.resources[0].status.interfaces
               | selectattr('ipAddresses','defined')
               | map(attribute='ipAddresses')
               | sum(start=[])
               | select('match','^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$')
               | list)[0] }}
      when: (vmi_info.resources | length > 0) and
            (vmi_info.resources[0].status.interfaces is defined)

    - name: Display fetched VM IPv4
      debug:
        msg: "VM IPv4 Address: {{ vm_ip }}"

    # -------------------------------
    # Service creation now uses vm_ip if needed
    # -------------------------------
    - name: Create Service for Apache VM
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ vm_name }}-service"
            namespace: "{{ vm_namespace }}"
            labels:
              app: "{{ vm_name }}"
          spec:
            selector:
              vm.kubevirt.io/name: "{{ vm_name }}"
            ports:
              - name: http
                protocol: TCP
                port: 80
                targetPort: 80
            type: ClusterIP

    - name: Create Route for Apache VM
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: "{{ vm_name }}-route"
            namespace: "{{ vm_namespace }}"
            labels:
              app: "{{ vm_name }}"
          spec:
            to:
              kind: Service
              name: "{{ vm_name }}-service"
              weight: 100
            port:
              targetPort: http
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect
            wildcardPolicy: None
