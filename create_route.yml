---
- hosts: localhost
  gather_facts: no
  tasks:
    - name: Get VM information
      kubernetes.core.k8s_info:
        api_version: kubevirt.io/v1
        kind: VirtualMachine
        name: "{{ vm_name | default('apache-vm') }}"
        namespace: "{{ vm_namespace | default('vm-migration-test') }}"
      register: vm_info
      ignore_errors: yes

    - name: Display VM labels for debugging
      debug:
        msg: "VM Labels: {{ vm_info.resources[0].metadata.labels }}"
      when: vm_info.resources | length > 0

    - name: Create Service for Apache VM
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ vm_name | default('apache-vm') }}-service"
            namespace: "{{ vm_namespace | default('vm-migration-test') }}"
            labels:
              app: "{{ vm_name | default('apache-vm') }}"
          spec:
            selector:
              vm.kubevirt.io/name: "{{ vm_name | default('apache-vm') }}"
            ports:
              - name: http
                protocol: TCP
                port: 80
                targetPort: 80
            type: ClusterIP

    - name: Create Route for Apache VM
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: "{{ vm_name | default('apache-vm') }}-route"
            namespace: "{{ vm_namespace | default('vm-migration-test') }}"
            labels:
              app: "{{ vm_name | default('apache-vm') }}"
          spec:
            to:
              kind: Service
              name: "{{ vm_name | default('apache-vm') }}-service"
              weight: 100
            port:
              targetPort: http
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect
            wildcardPolicy: None

    - name: Wait for Route to be ready
      kubernetes.core.k8s_info:
        api_version: route.openshift.io/v1
        kind: Route
        name: "{{ vm_name | default('apache-vm') }}-route"
        namespace: "{{ vm_namespace | default('vm-migration-test') }}"
      register: route_info
      until: route_info.resources[0].status.ingress[0].routerCanonicalHostname is defined
      retries: 10
      delay: 3

    - name: Display deployment information
      debug:
        msg:
          - "=========================================================================="
          - "Henogez WebServer Route Created Successfully!"
          - "=========================================================================="
          - "Access your web server at:"
          - ""
          - "External URL (HTTPS):"
          - "https://{{ route_info.resources[0].status.ingress[0].routerCanonicalHostname }}"
          - ""
          - "External URL (HTTP - will redirect):"
          - "http://{{ route_info.resources[0].status.ingress[0].routerCanonicalHostname }}"
          - ""
          - "Internal Service URL:"
          - "http://{{ vm_name | default('apache-vm') }}-service.{{ vm_namespace | default('vm-migration-test') }}.svc.cluster.local"
          - ""
          - "Resource Details:"
          - "VM Name: {{ vm_name | default('apache-vm') }}"
          - "Namespace: {{ vm_namespace | default('vm-migration-test') }}"
          - "Service: {{ vm_name | default('apache-vm') }}-service"
          - "Route: {{ vm_name | default('apache-vm') }}-route"
          - ""
          - "Route Status: Admitted: {{ route_info.resources[0].status.ingress[0].conditions[0].status | default('Unknown') }}"
          - ""
          - "Troubleshooting Commands:"
          - "oc get svc {{ vm_name | default('apache-vm') }}-service -n {{ vm_namespace | default('vm-migration-test') }}"
          - "oc get endpoints {{ vm_name | default('apache-vm') }}-service -n {{ vm_namespace | default('vm-migration-test') }}"
          - "oc get route {{ vm_name | default('apache-vm') }}-route -n {{ vm_namespace | default('vm-migration-test') }}"
          - "curl -k https://{{ route_info.resources[0].status.ingress[0].routerCanonicalHostname }}"
          - "=========================================================================="
