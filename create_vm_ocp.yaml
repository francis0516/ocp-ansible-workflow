---
- name: Create VM on OpenShift Virtualization with IPv4 extraction
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # VM Configuration
    vm_name: apache-vm
    vm_project: vm-migration-test
    storage_class: nfs-storage-class
    storage_size: 15Gi
    memory_size: 2Gi
    cpu_cores: 2
    cpu_sockets: 1
    cpu_threads: 1

    # Authentication
    cloud_init_password: password

    # Network Configuration
    network_attachment: br-ex-network

    # Timing Configuration
    ip_poll_interval: 10        # Seconds between IP checks
    max_ip_retries: 18          # Max retries (18 * 10 = 3 minutes)

  tasks:
    # ==========================================================================
    # STEP 1: DISPLAY CONFIGURATION
    # ==========================================================================
    - name: Display VM configuration
      debug:
        msg:
          - "=========================================="
          - "Creating VM: {{ vm_name }}"
          - "Namespace: {{ vm_project }}"
          - "Memory: {{ memory_size }}"
          - "CPU Cores: {{ cpu_cores }}"
          - "Storage Class: {{ storage_class }}"
          - "Network: {{ network_attachment }}"
          - "=========================================="

    # ==========================================================================
    # STEP 2: CREATE VIRTUAL MACHINE
    # ==========================================================================
    - name: Provision Virtual Machine in OpenShift
      kubernetes.core.k8s:
        state: present
        validate_certs: no
        definition:
          apiVersion: kubevirt.io/v1
          kind: VirtualMachine
          metadata:
            name: "{{ vm_name }}"
            namespace: "{{ vm_project }}"
            labels:
              app: "{{ vm_name }}"
          spec:
            running: true
            dataVolumeTemplates:
              - metadata:
                  name: "{{ vm_name }}"
                  annotations:
                    cdi.kubevirt.io/storage.bind.immediate.requested: "true"
                spec:
                  source:
                    pvc:
                      name: centos9-golden-image
                      namespace: "{{ vm_project }}"
                  storage:
                    storageClassName: "{{ storage_class }}"
                    accessModes: ["ReadWriteMany"]
                    volumeMode: Filesystem
                    resources:
                      requests:
                        storage: "{{ storage_size }}"
            template:
              metadata:
                labels:
                  kubevirt.io/domain: "{{ vm_name }}"
              spec:
                domain:
                  cpu:
                    cores: "{{ cpu_cores }}"
                    sockets: "{{ cpu_sockets }}"
                    threads: "{{ cpu_threads }}"
                  memory:
                    guest: "{{ memory_size }}"
                  devices:
                    disks:
                      - name: rootdisk
                        disk:
                          bus: virtio
                      - name: cloudinitdisk
                        disk:
                          bus: virtio
                    interfaces:
                      - name: br-ex-net
                        bridge: {}
                networks:
                  - name: br-ex-net
                    multus:
                      networkName: "{{ vm_project }}/{{ network_attachment }}"
                volumes:
                  - name: rootdisk
                    dataVolume:
                      name: "{{ vm_name }}"
                  - name: cloudinitdisk
                    cloudInitNoCloud:
                      networkData: |
                        version: 2
                        ethernets:
                          eth0:
                            dhcp4: true
                      userData: |
                        #cloud-config
                        user: root
                        password: {{ cloud_init_password }}
                        chpasswd: { expire: False }
                        ssh_pwauth: True
                        runcmd:
                          - sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
                          - sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
                          - systemctl restart sshd
                          - systemctl enable sshd
      register: vm_creation

    - name: Display VM creation result
      debug:
        msg: "VM {{ vm_name }} provisioned successfully"
      when: vm_creation.changed

    # ==========================================================================
    # STEP 3: WAIT FOR DATAVOLUME
    # ==========================================================================
    - name: Wait for DataVolume to be ready
      kubernetes.core.k8s_info:
        api_version: cdi.kubevirt.io/v1beta1
        kind: DataVolume
        name: "{{ vm_name }}"
        namespace: "{{ vm_project }}"
        validate_certs: no
      register: dv_info
      until:
        - dv_info.resources | length > 0
        - dv_info.resources[0].status.phase == "Succeeded"
      retries: 60
      delay: 10

    - name: Display DataVolume status
      debug:
        msg: "DataVolume ready (Phase: {{ dv_info.resources[0].status.phase }})"

    # ==========================================================================
    # STEP 4: WAIT FOR VM TO BE RUNNING
    # ==========================================================================
    - name: Wait for VM to be running
      kubernetes.core.k8s_info:
        api_version: kubevirt.io/v1
        kind: VirtualMachineInstance
        name: "{{ vm_name }}"
        namespace: "{{ vm_project }}"
        validate_certs: no
      register: vmi_info
      until:
        - vmi_info.resources | length > 0
        - vmi_info.resources[0].status.phase == "Running"
      retries: 30
      delay: 10

    - name: Display VM running status
      debug:
        msg: "VM {{ vm_name }} is running, waiting for IPv4 address..."

    # ==========================================================================
    # STEP 5: EXTRACT IPV4 (GUEST AGENT + SSH FALLBACK)
    # ==========================================================================
    - name: Initialize IPv4 variables
      set_fact:
        vm_ipv4_addresses: []
        vm_ip: "No IPv4 assigned"
        all_ips: []

    - name: Poll for IPv4 via guest agent
      kubernetes.core.k8s_info:
        api_version: kubevirt.io/v1
        kind: VirtualMachineInstance
        name: "{{ vm_name }}"
        namespace: "{{ vm_project }}"
        validate_certs: no
      register: vmi_network_info
      until: >-
        (vmi_network_info.resources | length > 0) and
        ((vmi_network_info.resources[0].status.interfaces | default([]) |
        map(attribute='ipAddresses') |
        select('defined') |
        map('flatten') |
        flatten |
        select('match', '^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$') |
        list | length) > 0)
      retries: "{{ max_ip_retries }}"
      delay: "{{ ip_poll_interval }}"
      ignore_errors: true

    - name: Extract IPv4 addresses from guest agent
      set_fact:
        all_ips: >-
          {{
            (vmi_network_info.resources[0].status.interfaces | default([])) |
            map(attribute='ipAddresses') |
            select('defined') |
            map('flatten') |
            flatten |
            list
          }}
        vm_ipv4_addresses: >-
          {{
            (vmi_network_info.resources[0].status.interfaces | default([])) |
            map(attribute='ipAddresses') |
            select('defined') |
            map('flatten') |
            flatten |
            select('match', '^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$') |
            list
          }}

    - name: Display guest agent result
      debug:
        msg: "{{ '✓' if vm_ipv4_addresses | length > 0 else '✗' }} Guest agent: {{ vm_ipv4_addresses | join(', ') if vm_ipv4_addresses | length > 0 else 'No IPv4 reported' }}"

    - name: Try SSH fallback if guest agent failed
      block:
        - name: Get connection IP for SSH
          set_fact:
            ssh_ip: "{{ vmi_network_info.resources[0].status.interfaces[0].ipAddress | default('') }}"

        - name: Display SSH fallback attempt
          debug:
            msg: "Guest agent failed, attempting SSH extraction via {{ ssh_ip }}..."

        - name: Wait for SSH to be available
          wait_for:
            host: "{{ ssh_ip }}"
            port: 22
            timeout: 90
            delay: 10
          when: ssh_ip != ''
          ignore_errors: true
          register: ssh_available

        - name: Extract IPv4 via SSH
          shell: |
            sshpass -p '{{ cloud_init_password }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 root@{{ ssh_ip }} "ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1"
          register: ssh_ipv4
          when:
            - ssh_ip != ''
            - ssh_available is succeeded
          ignore_errors: true
          changed_when: false

        - name: Store SSH-extracted IPv4
          set_fact:
            vm_ipv4_addresses: ["{{ ssh_ipv4.stdout | trim }}"]
          when:
            - ssh_ipv4 is defined
            - ssh_ipv4.rc is defined
            - ssh_ipv4.rc == 0
            - ssh_ipv4.stdout | trim != ''

        - name: Display SSH extraction result
          debug:
            msg: "{{ '✓' if vm_ipv4_addresses | length > 0 else '✗' }} SSH extraction: {{ vm_ipv4_addresses | join(', ') if vm_ipv4_addresses | length > 0 else 'Failed' }}"
      when: vm_ipv4_addresses | length == 0

    - name: Set final VM IP
      set_fact:
        vm_ip: "{{ vm_ipv4_addresses[0] if vm_ipv4_addresses | length > 0 else 'No IPv4 assigned' }}"

    - name: Display network information
      debug:
        msg:
          - "================================================"
          - "Network Information for {{ vm_name }}"
          - "================================================"
          - "All IPs detected: {{ all_ips | join(', ') if all_ips | length > 0 else 'None' }}"
          - "IPv4 addresses: {{ vm_ipv4_addresses | join(', ') }}"
          - "Selected IPv4: {{ vm_ip }}"
          - "Detection method: {{ 'Guest Agent' if vm_ipv4_addresses | length > 0 else 'SSH Fallback' }}"
          - "================================================"

    - name: Fail if no IPv4 address obtained
      fail:
        msg: |
          ========================================
          ERROR: No IPv4 address could be obtained
          ========================================
          
          VM Name: {{ vm_name }}
          All IPs: {{ all_ips }}
          
          Guest Agent: Failed to report IPv4
          SSH Fallback: Failed to extract IPv4
          
          ROOT CAUSE:
          Your NetworkAttachmentDefinition is missing the "subnets" field.
          
          SOLUTION:
          1. Update your br-ex-network NAD to include the subnet:
             
             oc edit network-attachment-definitions br-ex-network -n {{ vm_project }}
             
             Add this line in the config (before closing brace):
             "subnets":"10.0.0.0/24"
          
          2. Delete and restart the VM:
             oc delete vmi {{ vm_name }} -n {{ vm_project }}
          
          3. Verify the fix:
             oc get vmi {{ vm_name }} -n {{ vm_project }} -o jsonpath='{.status.interfaces[0].ipAddresses}'
             (Should show: ["10.0.0.X","fe80::..."])
          
          4. Run the playbook again
      when: vm_ip == 'No IPv4 assigned'

    # ==========================================================================
    # STEP 6: CHECK GUEST AGENT STATUS
    # ==========================================================================
    - name: Check guest agent connection status
      set_fact:
        guest_agent_connected: >-
          {{
            (vmi_network_info.resources[0].status.conditions | default([]) |
            selectattr('type', 'equalto', 'AgentConnected') |
            map(attribute='status') | first | default('Unknown'))
          }}

    # ==========================================================================
    # STEP 7: EXPORT VARIABLES FOR DOWNSTREAM JOBS
    # ==========================================================================
    - name: Export variables for workflow
      set_stats:
        data:
          vm_ip: "{{ vm_ip }}"
          vm_ipv4: "{{ vm_ipv4_addresses | join(',') }}"
          vm_name: "{{ vm_name }}"
          vm_project: "{{ vm_project }}"
        per_host: no

    # ==========================================================================
    # STEP 8: DISPLAY DEPLOYMENT SUMMARY
    # ==========================================================================
    - name: Deployment summary
      debug:
        msg:
          - "=========================================="
          - "VM Deployment Complete!"
          - "=========================================="
          - "VM Name: {{ vm_name }}"
          - "Namespace: {{ vm_project }}"
          - "IPv4 Address: {{ vm_ip }}"
          - "All IPv4s: {{ vm_ipv4_addresses | join(', ') }}"
          - "Username: root"
          - "Password: {{ cloud_init_password }}"
          - "Network: {{ network_attachment }}"
          - "Guest Agent: {{ guest_agent_connected }}"
          - "Detection Method: {{ 'Guest Agent ✓' if vm_ipv4_addresses | length > 0 else 'SSH Fallback ⚠' }}"
          - ""
          - "Exported Variables:"
          - "  vm_ip: {{ vm_ip }}"
          - "  vm_name: {{ vm_name }}"
          - "  vm_project: {{ vm_project }}"
          - "=========================================="
